import scrapy
from urllib.parse import quote
from urllib.parse import unquote
from urllib import parse
def qs(url):
    parseResult = parse.urlparse(url)
    param_dict = parse.parse_qs(parseResult.query)
    return param_dict
class CnkiSpider(scrapy.Spider):
    name = 'ziranjijin2'
    start_urls = ['http://www.baidu.com']
    file=open('teacher/data/清华_自然基金2.csv','a',encoding='utf8')

    def __init__(self):
        self.year = [str(y) for y in range(1997, 2019)]
        self.level = ["面上项目", "重点项目", "重大项目", "重大研究计划", "国家杰出青年科学基金", "创新研究群体科学基金", "国际（地区）合作与交流项目", "专项基金项目", "联合基金项目",
                 "海外或港、澳青年学者合作研究基金", "青年科学基金项目", "地区科学基金项目", "海外及港澳学者合作研究基金", "国家基础科学人才培养基金", "国家重大科研仪器研制项目", "应急管理项目",
                 "优秀青年基金项目", "国际（地区）合作与交流项目"]
        self.dic = {y: {l: {'all': -1, 'list': []} for l in self.level} for y in self.year}
        self.tmp = {'1997': {'面上项目': {'all': 5, 'list': ['1', '4', '3', '2', '5']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 0, 'list': []}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 0, 'list': []}, '国际（地区）合作与交流项目': {'all': 0, 'list': []}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 2, 'list': ['1', '2']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 0, 'list': []}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '1998': {'面上项目': {'all': 6, 'list': ['1', '5', '4', '3', '2', '6']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 0, 'list': []}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 0, 'list': []}, '国际（地区）合作与交流项目': {'all': 0, 'list': []}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 1, 'list': ['1']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 0, 'list': []}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '1999': {'面上项目': {'all': 5, 'list': ['1', '4', '2', '5', '3']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 0, 'list': []}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 0, 'list': []}, '国际（地区）合作与交流项目': {'all': 0, 'list': []}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 1, 'list': ['1']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2000': {'面上项目': {'all': 5, 'list': ['1', '4', '2', '3', '5']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 0, 'list': []}, '重大研究计划': {'all': 0, 'list': []}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 0, 'list': []}, '国际（地区）合作与交流项目': {'all': 0, 'list': []}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 2, 'list': ['1', '2']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2001': {'面上项目': {'all': 13, 'list': ['1', '9', '12', '10', '6', '7', '5', '3', '4', '2', '8', '13', '11']}, '重点项目': {'all': 2, 'list': ['1', '2']}, '重大项目': {'all': 0, 'list': []}, '重大研究计划': {'all': 1, 'list': ['1']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 2, 'list': ['1', '2']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 3, 'list': ['1', '2', '3']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2002': {'面上项目': {'all': 8, 'list': ['1', '6', '3', '5', '4', '2', '7', '8']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 0, 'list': []}, '重大研究计划': {'all': 1, 'list': ['1']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 9, 'list': ['1', '6', '8', '7', '2', '5', '4', '3', '9']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 3, 'list': ['1', '2', '3']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2003': {'面上项目': {'all': 7, 'list': ['1', '5', '4', '6', '3', '2', '7']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 1, 'list': ['1']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 8, 'list': ['1', '7', '5', '6', '2', '4', '3', '8']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 2, 'list': ['1', '2']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2004': {'面上项目': {'all': 9, 'list': ['1', '8', '6', '2', '7', '4', '5', '3', '9']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 2, 'list': ['1', '2']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 0, 'list': []}, '国际（地区）合作与交流项目': {'all': 11, 'list': ['1', '10', '4', '2', '3', '9', '5', '8', '11', '7', '6']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 4, 'list': ['1', '2', '4', '3']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2005': {'面上项目': {'all': 11, 'list': ['1', '7', '5', '6', '10', '9', '3', '8', '4', '11', '2']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 1, 'list': ['1']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 0, 'list': []}, '国际（地区）合作与交流项目': {'all': 10, 'list': ['1', '9', '8', '7', '3', '2', '4', '6', '5', '10']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 5, 'list': ['1', '4', '3', '2', '5']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2006': {'面上项目': {'all': 10, 'list': ['1', '9', '5', '4', '2', '3', '6', '7', '8', '10']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 0, 'list': []}, '重大研究计划': {'all': 1, 'list': ['1']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 6, 'list': ['1', '5', '4', '2', '3', '6']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 4, 'list': ['1', '3', '2', '4']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 1, 'list': ['1']}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2007': {'面上项目': {'all': 11, 'list': ['1', '10', '4', '3', '8', '7', '9', '5', '2', '6', '11']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 0, 'list': []}, '重大研究计划': {'all': 2, 'list': ['1', '2']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 7, 'list': ['1', '4', '6', '5', '2', '3', '7']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 4, 'list': ['1', '2', '3', '4']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2008': {'面上项目': {'all': 11, 'list': ['1', '10', '9', '7', '8', '6', '5', '2', '3', '4', '11']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 2, 'list': ['1', '2']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 0, 'list': []}, '国际（地区）合作与交流项目': {'all': 6, 'list': ['1', '5', '3', '2', '4', '6']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 0, 'list': []}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 4, 'list': ['1', '3', '2', '4']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2009': {'面上项目': {'all': 14, 'list': ['1', '13', '8', '7', '9', '5', '12', '11', '10', '4', '3', '6', '2', '14']}, '重点项目': {'all': 1, 'list': ['1']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 1, 'list': ['1']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 6, 'list': ['1', '4', '2', '3', '5', '6']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 5, 'list': ['1', '4', '2', '3', '5']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 0, 'list': []}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2010': {'面上项目': {'all': 24, 'list': ['1', '23', '18', '21', '22', '20', '17', '12', '14', '8', '4', '13', '19', '10', '5', '6', '3', '2', '9', '11', '15', '24', '16', '7']}, '重点项目': {'all': 3, 'list': ['1', '2', '3']}, '重大项目': {'all': 0, 'list': []}, '重大研究计划': {'all': 3, 'list': ['1', '2', '3']}, '国家杰出青年科学基金': {'all': 2, 'list': ['1', '2']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 5, 'list': ['1', '2', '5', '4', '3']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 12, 'list': ['1', '5', '3', '4', '2', '6', '8', '11', '10', '12', '7', '9']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 1, 'list': ['1']}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 3, 'list': ['1', '2', '3']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2011': {'面上项目': {'all': 31, 'list': ['1', '29', '23', '27', '24', '30', '25', '22', '26', '19', '18', '6', '3', '5', '4', '2', '7', '8', '10', '11', '14', '9', '16', '20', '17', '21', '15', '12', '13', '28', '31']}, '重点项目': {'all': 3, 'list': ['1', '2', '3']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 2, 'list': ['1', '2']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 7, 'list': ['1', '2', '4', '5', '6', '3', '7']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 16, 'list': ['1', '15', '13', '11', '14', '6', '4', '12', '5', '2', '3', '10', '8', '9', '7', '16']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 1, 'list': ['1']}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 0, 'list': []}}, '2012': {'面上项目': {'all': 30, 'list': ['1', '17', '18', '13', '14', '15', '16', '12', '9', '10', '3', '11', '7', '6', '8', '5', '4', '2', '22', '25', '19', '26', '21', '27', '30', '28', '24', '23', '20', '29']}, '重点项目': {'all': 3, 'list': ['1', '2', '3']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 2, 'list': ['1', '2']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 7, 'list': ['1', '6', '5', '2', '3', '7', '4']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 15, 'list': ['1', '8', '7', '3', '13', '2', '4', '6', '11', '5', '14', '9', '15', '10', '12']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 1, 'list': ['1']}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 2, 'list': ['1', '2']}}, '2013': {'面上项目': {'all': 29, 'list': ['1', '12', '11', '10', '7', '6', '26', '21', '25', '3', '23', '4', '18', '28', '20', '22', '8', '9', '27', '19', '5', '24', '16', '17', '14', '13', '15', '2', '29']}, '重点项目': {'all': 2, 'list': ['1', '2']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 2, 'list': ['1', '2']}, '国家杰出青年科学基金': {'all': 2, 'list': ['1', '2']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 4, 'list': ['1', '3', '2', '4']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 13, 'list': ['1', '11', '6', '4', '7', '9', '3', '2', '8', '5', '12', '13', '10']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 1, 'list': ['1']}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 2, 'list': ['1', '2']}, '优秀青年基金项目': {'all': 3, 'list': ['1', '2', '3']}}, '2014': {'面上项目': {'all': 27, 'list': ['1', '22', '20', '21', '23', '17', '13', '18', '19', '15', '16', '14', '4', '5', '7', '3', '8', '6', '2', '9', '11', '12', '10', '24', '25', '27', '26']}, '重点项目': {'all': 2, 'list': ['1', '2']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 2, 'list': ['1', '2']}, '国家杰出青年科学基金': {'all': 2, 'list': ['1', '2']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 5, 'list': ['1', '2', '3', '4', '5']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 2, 'list': ['1', '2']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 12, 'list': ['1', '10', '11', '6', '5', '7', '9', '4', '3', '8', '2', '12']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 1, 'list': ['1']}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 2, 'list': ['1', '2']}, '优秀青年基金项目': {'all': 3, 'list': ['1', '2', '3']}}, '2015': {'面上项目': {'all': 28, 'list': ['1', '27', '21', '23', '19', '20', '17', '15', '10', '26', '9', '14', '3', '2', '4', '7', '6', '5', '12', '13', '24', '16', '28', '11', '8', '18', '22', '25']}, '重点项目': {'all': 3, 'list': ['1', '2', '3']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 3, 'list': ['1', '2', '3']}, '国家杰出青年科学基金': {'all': 1, 'list': ['1']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 5, 'list': ['1', '4', '3', '2', '5']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 2, 'list': ['1', '2']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 12, 'list': ['1', '8', '11', '3', '2', '9', '10', '4', '6', '7', '5', '12']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 1, 'list': ['1']}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 3, 'list': ['1', '2', '3']}}, '2016': {'面上项目': {'all': 29, 'list': ['1', '28', '26', '27', '24', '14', '13', '18', '17', '11', '16', '23', '10', '15', '20', '22', '9', '6', '3', '4', '5', '7', '8', '19', '21', '12', '25', '29', '2']}, '重点项目': {'all': 4, 'list': ['1', '3', '4', '2']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 4, 'list': ['1', '3', '2', '4']}, '国家杰出青年科学基金': {'all': 2, 'list': ['1', '2']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 6, 'list': ['1', '4', '3', '5', '6', '2']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 2, 'list': ['1', '2']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 10, 'list': ['1', '2', '9', '7', '10', '4', '6', '3', '8', '5']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 2, 'list': ['1', '2']}, '优秀青年基金项目': {'all': 2, 'list': ['1', '2']}}, '2017': {'面上项目': {'all': 29, 'list': ['1', '28', '21', '19', '20', '18', '25', '24', '27', '14', '12', '16', '9', '7', '13', '3', '23', '11', '10', '5', '15', '26', '2', '6', '8', '4', '17', '22', '29']}, '重点项目': {'all': 3, 'list': ['1', '2', '3']}, '重大项目': {'all': 2, 'list': ['1', '2']}, '重大研究计划': {'all': 3, 'list': ['1', '2', '3']}, '国家杰出青年科学基金': {'all': 2, 'list': ['1', '2']}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 6, 'list': ['1', '3', '4', '5', '2', '6']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 3, 'list': ['1', '2', '3']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 12, 'list': ['1', '9', '7', '4', '10', '3', '6', '11', '5', '8', '2', '12']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 3, 'list': ['1', '2', '3']}, '优秀青年基金项目': {'all': 3, 'list': ['1', '2', '3']}}, '2018': {'面上项目': {'all': 26, 'list': ['1', '23', '24', '18', '25', '19', '22', '16', '21', '11', '20', '7', '12', '10', '9', '14', '8', '6', '15', '17', '5', '2', '13', '4', '26', '3']}, '重点项目': {'all': 3, 'list': ['1', '2', '3']}, '重大项目': {'all': 1, 'list': ['1']}, '重大研究计划': {'all': 0, 'list': []}, '国家杰出青年科学基金': {'all': 0, 'list': []}, '创新研究群体科学基金': {'all': 1, 'list': ['1']}, '国际（地区）合作与交流项目': {'all': 4, 'list': ['1', '2', '3', '4']}, '专项基金项目': {'all': 0, 'list': []}, '联合基金项目': {'all': 1, 'list': ['1']}, '海外或港、澳青年学者合作研究基金': {'all': 0, 'list': []}, '青年科学基金项目': {'all': 14, 'list': ['1', '13', '11', '8', '10', '3', '7', '5', '12', '4', '2', '6', '9', '14']}, '地区科学基金项目': {'all': 0, 'list': []}, '海外及港澳学者合作研究基金': {'all': 1, 'list': ['1']}, '国家基础科学人才培养基金': {'all': 0, 'list': []}, '国家重大科研仪器研制项目': {'all': 1, 'list': ['1']}, '应急管理项目': {'all': 1, 'list': ['1']}, '优秀青年基金项目': {'all': 2, 'list': ['1', '2']}}}
    def start_requests(self):
        self.dic=self.tmp
        # self.file.write('负责人,机构,金额,项目编号,项目类型,学部,年份,题目,学科\n')
        for y in self.year:
            for l in self.level:
                if self.dic[y][l]['all']==-1:
                    url = self.getUrl(y, l, 1)

                    yield scrapy.Request(url, callback=self.parse)
                else:
                    for i in range(1,self.dic[y][l]['all']+1):
                        if str(i) not in  self.dic[y][l]['list']:
                            url=self.getUrl(y,l,i)

                            yield scrapy.Request(url, callback=self.parse)
    def getUrl(self,year,level,page):
        level = quote(level, 'utf-8')
        url = 'http://www.letpub.com.cn/index.php?page=grant&name=&person=&no=&company=%E6%B8%85%E5%8D%8E%E5%A4%A7%E5%AD%A6&startTime='+year+'&endTime='+year+'&money1=&money2=&subcategory='+level+'&addcomment_s1=0&addcomment_s2=0&addcomment_s3=0&currentpage='+str(page)
        return url

    def parse(self, response):
        page = qs(response.url)['currentpage'][0]
        year = qs(response.url)['startTime'][0]
        level=unquote(qs(response.url)['subcategory'][0], 'utf-8')
        ziran= response.xpath('//table[@class="table_yjfx"]/tr')[2:-1]
        if int(page)==1:
            all = response.xpath('//center[1]/div/text()').extract()[0]
            index=all.find('条记录！')
            all_p=int(all[7:all.find('条记录！')])
            t=int(all_p/10)
            if all_p%10!=0:
                t+=1
            self.dic[year][level]['all']=t
            for i in range(2,t):
                if str(i) not in self.dic[year][level]['list']:
                    url = self.getUrl(year,level, i)
                    yield scrapy.Request(url, callback=self.parse)
        if (len(ziran)<1) and self.dic[year][level]['all']==0:
            print(response.url)
            print(len(ziran))
            print('缺')
            print(self.dic)
            print()
        else:
            if page not in self.dic[year][level]['list']:
                self.dic[year][level]['list'].append(page)
        for i in range(int(len(ziran)/3)):
            node1,node2,node3=ziran[3*i],ziran[3*i+1],ziran[3*i+2]
            name=node1.xpath('./td[1]/text()').extract()[0]
            org = node1.xpath('./td[2]/text()').extract()[0]
            money = node1.xpath('./td[3]/text()').extract()[0]
            id = node1.xpath('./td[4]/text()').extract()[0]
            type = node1.xpath('./td[5]/text()').extract()[0]
            try:
                belong = node1.xpath('./td[6]/text()').extract()[0]
            except:
                belong=''
            year= node1.xpath('./td[7]/text()').extract()[0]
            title= node2.xpath('./td[2]/text()').extract()[0]
            level=node3.xpath('./td[2]/text()').extract()[0]
            tmp=name+','+org+','+money+','+id +','+type+','+belong +','+year+','+title+','+level
            self.file.write(tmp+'\n')
    @staticmethod
    def close(spider, reason):
        print('end55')
        print(spider.dic)
        closed = getattr(spider, 'closed', None)
        if callable(closed):
            return closed(reason)


